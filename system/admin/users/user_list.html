<html>

<head>
    <meta charset="utf-8">

    <link href="../../css/componente_multiselecao.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style_base_cadastro_editar.css">

    <style>
        td input[type="checkbox"] {
            float: none;
            margin: 5px 5px auto auto;
        }
    </style>
</head>

<body>
    <div class="borda" style=" margin-top:3%;">
        <h3>Usuários</h3>
        <div class="alert collapse alert-dismissible fade show" role="alert" id="item_alert">
            <span id="alert_message"></span>
            <button type="button" class="close" onclick="alert_close()"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="container">
            <div class="row">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#add_user_m">Adicionar</button>
                    <!-- <button type="button" id="button_remove" class="btn btn-secondary btn-sm" onclick="remove_checked()" disabled>Remover</button> -->
                </div>
            </div>

            <div class="row" style="margin-top:2%;">
                <div class="table-responsive">
                    <table class="table table-striped" id="userlist">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col"></th>
                                <th scope="col">Nome</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">Cpf</th>
                                <th scope="col">Status</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="add_user_m" tabindex="-1" role="dialog" aria-labelledby="adduser_m" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Adicionar usuário</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="users/user_add.php" id="suform">
                        <div class="form-group">
                            <label for="name">Nome</label>
                            <input type="text" class="form-control" name="name" id="name" required>
                        </div>

                        <div class="form-group">
                            <label for="cpf">Cpf</label>
                            <input type="number" class="form-control" name="cpf" id="cpf" required>
                            <div class="invalid-feedback" id="cpffeedback"></div>
                        </div>

                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" class="form-control" name="email" id="email" required>
                        </div>

                        <div class="form-row">
                            <div class="col-md-6 mb-4">
                                <label for="password0">Senha</label>
                                <input type="password" class="form-control" name="password" id="password0" required>
                                <div class="invalid-feedback" id="passwfeedback"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="password1">Confirmar senha</label>
                                <input type="password" class="form-control" id="password1" required>
                            </div>
                        </div>

                        <fieldset class="form-group">
                            <label for="sex">Sexo</legend>
                                <select name="sex" id="sex" class="form-control form-control-sm">
                                    <option value="Masculino" selected>Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                </select>
                        </fieldset>

                        <fieldset class="form-group">
                            <label for="usertype">Tipo de usuário</legend>
                                <select name="usertype" id="usertype" class="form-control form-control-sm">
                                    <option value="Administrador" selected>Administrador</option>
                                    <option value="Líder">Líder</option>
                                    <option value="Colaborador">Colaborador</option>
                                </select>
                        </fieldset>

                        <div class="modal-footer">
                            <button id="subb" type="submit" class="btn btn-primary">Cadastrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="edit_user_m" tabindex="-1" role="dialog" aria-labelledby="edituser_m" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar usuário</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h6 id="editcpfw"></h6>
                    <form action="users/user_edit.php" id="edsuform">
                        <div class="form-group">
                            <label for="namew">Nome</label>
                            <input type="text" class="form-control" name="name" id="namew" required>
                        </div>

                        <div class="form-group">
                            <label for="emailw">E-mail</label>
                            <input type="email" class="form-control" name="email" id="emailw" required>
                        </div>

                        <div class="form-group">
                            <label for="cpfw">Cpf</label>
                            <input type="number" class="form-control" name="cpf" id="cpfw" readonly>
                        </div>

                        <fieldset class="form-group">
                            <label for="sexw">Sexo</legend>
                                <select name="sex" id="sexw" class="form-control form-control-sm">
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                </select>
                        </fieldset>

                        <fieldset class="form-group">
                            <label for="usertypew">Tipo de usuário</legend>
                                <select name="usertype" id="usertypew" class="form-control form-control-sm">
                                    <option value="Administrador">Administrador</option>
                                    <option value="Líder">Líder</option>
                                    <option value="Colaborador">Colaborador</option>
                                </select>
                        </fieldset>

                        <fieldset class="form-group">
                            <label for="statusw">Status</legend>
                                <select name="status" id="statusw" class="form-control form-control-sm">
                                    <option value="Ativo">Ativo</option>
                                    <option value="Desativado">Desativado</option>
                                </select>
                        </fieldset>

                        <div class="modal-footer">
                            <button id="subbw" type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        function ulistcheck()
        {
            $("#button_remove").attr("disabled", true);

            $("#userlist tbody tr").each(function ()
            {
                if ($(this).find('td input:checked').length > 0)
                {
                    $("#button_remove").attr("disabled", false);
                    return false;
                }
            });
        }


        function remove_checked()
        {
            $("#userlist tbody tr").each(function (key, value)
            {
                if ($(this).find('td input:checked').length > 0)
                {
                    var $td = $(this).find('td');
                    var p = $.post("users/user_remove.php", { cpf: $td[3].innerHTML });

                    p.done(() => makelist());
                }
            });
        }


        function edit_item(key)
        {
            var $list = $("#userlist tbody tr");
            var $td = $list.eq(key).find('td');

            $.getJSON("users/fetch_user.php", { value: $td[3].innerHTML }, function (data)
            {
                $("#namew").val(data.name);
                $("#usertypew").val(data.type);
                $("#emailw").val(data.email);
                $("#statusw").val(data.status);
                $("#sexw").val(data.sex);
                $("#cpfw").val(data.cpf);

                if (data.adm === "True") $("#usertypew").attr("disabled", "disabled");
                else $("#usertypew").removeAttr("disabled");

                $("#edit_user_m").modal("show");
            });
        }


        $("#edsuform").submit(function (event)
        {
            event.preventDefault();

            var $form = $(this);

            var url = $form.attr("action");

            var fields = $form.serializeArray();
            //    fields.append({cpf: });

            var p = $.post(url, fields);

            p.done(function (data)
            {
                $("#item_alert").removeClass("alert-success");
                $("#item_alert").removeClass("alert-danger");

                if (data === "status:ok")
                {
                    $("#alert_message").text("Usuário editado com sucesso.");
                    $("#item_alert").addClass("alert-success");

                }
                else
                {
                    $("#alert_message").text("Erro ao editar usuário.");
                    $("#item_alert").addClass("alert-danger");
                }

                $("#item_alert").show();

                $("#edit_user_m").modal("toggle");

                $form.trigger('reset');

                makelist();
            });
        });

        function alert_close()
        {
            $("#item_alert").hide();
        }


        function makelist()
        {
            $("#button_remove").attr("disabled", true);
            $("#button_edit").attr("disabled", true);

            $.getJSON("users/fetch_user_list.php", function (data)
            {
                $("#userlist tbody").empty();
                var tr = '';

                $.each(data, function (key, value)
                {
                    tr += '<tr>';
                    tr += '<td style="text-align:center;"><input class="form-check-input" type="checkbox" onclick="ulistcheck()"' +
                        (value.adm === 'True' ? ' disabled' : ' ') + '></td>';
                    tr += '<td>' + value.name + '</td>';
                    tr += '<td>' + value.type + '</td>';
                    tr += '<td>' + value.cpf + '</td>';
                    tr += '<td>' + value.status + '</td>';
                    tr += '<td style="text-align:center;"><button type="button" class="btn btn-secondary btn-sm" onclick="edit_item(' + key + ')">Editar</button></td>';
                    tr += '</tr>';
                });

                $("#userlist tbody").append(tr);
            });
        }

        $("#suform").submit(function (event)
        {
            event.preventDefault();

            $("#cpf").removeClass("is-valid");
            $("#cpf").removeClass("is-invalid");

            if ($("#cpf").val().length != 11)
            {
                $("#cpf").addClass("is-invalid");
                $("#cpffeedback").empty();
                $("#cpffeedback").append("cpf possui ao menos 11 dígitos");
            }
            else
            {
                $("#cpf").addClass("is-valid");

                $("#password0").removeClass("is-invalid");
                $("#password1").removeClass("is-invalid");
                $("#password0").removeClass("is-valid");
                $("#password1").removeClass("is-valid");

                var passw = $("#password0").val();

                if (passw != $("#password1").val())
                {
                    $("#password0").addClass("is-invalid");
                    $("#password1").addClass("is-invalid");
                    $("#passwfeedback").empty();
                    $("#passwfeedback").append("digite a mesma senha");
                }
                else
                {
                    $("#passwfeedback").empty();
                    $("#password0").addClass("is-valid");
                    $("#password1").addClass("is-valid");

                    var $form = $(this);

                    var url = $form.attr("action");

                    var fields = $form.serializeArray();

                    var p = $.post(url, fields);

                    p.done(function (data)
                    {
                        $("#item_alert").removeClass("alert-success");
                        $("#item_alert").removeClass("alert-danger");

                        switch (data)
                        {
                            case "status:cpfinvalid":
                                $("#cpf").addClass("is-invalid");
                                $("#cpffeedback").empty();
                                $("#cpffeedback").append("Cpf já existe");
                                break;

                            case "status:ok":
                                $("#alert_message").text("Usuário cadastrado com sucesso.");
                                $("#item_alert").addClass("alert-success");
                                $("#item_alert").show();

                                clear_form();
                                break;


                            default:
                                $("#alert_message").text("Erro ao adicionar usuário.");
                                $("#item_alert").addClass("alert-danger");
                                $("#item_alert").show();

                                clear_form();
                                break;
                        }
                    });
                }
            }
        });


        function clear_form()
        {
            $("#add_user_m").modal("toggle");

            $form.trigger('reset');

            $("#cpf").removeClass("is-valid");
            $("#cpf").removeClass("is-invalid");

            $("#password0").removeClass("is-invalid");
            $("#password1").removeClass("is-invalid");
            $("#password0").removeClass("is-valid");
            $("#password1").removeClass("is-valid");

            makelist();
        }

        makelist();
    </script>

</body>

</html>
